#!/usr/bin/env bash

usage() {
  echo "$@" >&2
  echo "usage : $(basename $0) -n <VM_NAME> -i <ISO_FILE> [options]
  -n <VM_NAME> : sets the name of the new VM to create (mandatory)
  -i <ISO_FILE> : name of an iso to mount (absolute path or found in ${isoDir}) (mandatory)
  -h : display this help" >&2
  exit
}

realMe=$(readlink -e $0)
realDir=$(dirname ${realMe})
libDir=../lib
libName=cm_lib
[ -d "${realDir}/${libDir}" ]  || usage "${libDir} directory was not found in ${realDir} : Installation problem."
[ -f "${realDir}/${libDir}/${libName}" ] && . ${realDir}/${libDir}/${libName} || usage "${libName} was not found in ${realDir}/${libDir} : Installation problem."

vmName=
isoName=
adjust=0
while getopts n:i:h name
do
  case $name in
    n)
      vmName="$OPTARG"
      ;;
    i)
      isoName="$OPTARG"
      [ -f "${isoDir}/${isoName}" -o -f "${isoName}" ] || usage "can't find ${isoName}"
      ;;
    h)
      usage
      ;;
  esac
done
shift $(($OPTIND-1))

[ -z "$vmName" ] && usage "-n <VM_name> is mandatory"
[ -z "$isoName" ] && usage "-i <ISO_file> is mandatory"

vm_create ${vmName} ${vmCreateGroup} "" ${isoName}
